<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Battlestar Galactica</title>

    <!-- Bootstrap stylesheet -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome stylesheet -->
    <link href="/static/font-awesome-4.6.1/css/font-awesome.min.css" rel="stylesheet">
    <!-- Custom stylesheet -->
    <link href="/static/css/custom-css.css" rel="stylesheet">

</head>
<body>
    <!-- Navbar -->
    <nav id="navbar" class="navbar navbar-default navbar-fixed-top">
        <!-- Allows for fluid container for the navbar to stretch across the header. -->
        <div class="container-fluid">
            <!-- Will always be there in even when nav is collapsed -->
            <div class="navbar-header">
                <!-- Navbar dropdown button -->
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
                     <span class="sr-only">Toggle navigation</span>
                     <span class="icon-bar"></span>
                     <span class="icon-bar"></span>
                     <span class="icon-bar"></span>
                </button>
                <!-- FontAwesome insert (If wanted, direct to home)-->
            </div>
            <!-- Toggleable Area -->
            <div class="collapse navbar-collapse" id="navbar">
                <!-- Nav links -->
                <ul class="nav navbar-nav">
                    <li><a href="#index-container" id="index-link" class="nav-div-links" data-toggle="collapse" aria-expanded="true" aria-controls="map-container"><span class="text-primary">Index</span></a></li>
                    <li><a href="#map-container" id="map-link" class="nav-div-links" data-toggle="collapse" aria-expanded="false" aria-controls="map-container">Map</a></li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li><p id="warp-coords" class="next-turn navbar-text" hidden="hidden">Warp Coords</p></li>
                    <li><button id="warp" class="btn btn-default navbar-btn next-turn" disabled="disabled">Warp</button></li>
                    <li><button id="next-turn" class="btn btn-primary navbar-btn next-turn">Next Turn</button></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hidden Images -->
    <div hidden="hidden">
        <img src="/static/images/2016_tile.png" alt="star_tile" id="star_tile">
    </div>

    <!-- Fluid container for body -->
    <div class="container-fluid">

        <!-- Index page -->
        <div id="index-container" aria-expanded="true" class="collapse in">
            <div class="row">
                <div class="col-md-12">
                    <h1>Index</h1>
                    <hr>
                    <h2>Some Heading</h2>
                    <p>Lorem Ipsum Dolor some other text lmao</p>
                </div>
            </div>
        </div>

        <!-- Map page -->
        <div id="map-container" class="collapse" aria-expanded="false">
            <div class="row">
                <div class="col-md-12" id="map-header">
                    <h1>Map Page</h1>
                    <hr>
                </div>

                <div class="col-md-8" id="map-canvas">
                    <div id="star-map" style="overflow: scroll; position: relative; margin-bottom: 15px;" class="dragscroll" >
                        <canvas id="star-canvas" width="2016" height="2016"></canvas>
                        <!-- Location = (32 * x) + 32 | x = [0, 60] for perfect 16 pixel gaps between 16 pixel sprites. Midpoint is 992, 992 -->
                    </div>
                </div>

                <div class="col-md-4" id="map-side-bar" style="bottom: 100px; margin-top: 100px;">

                    <h1>System Info</h1>
                    <h4><small>System Name: </small><span id="system-name"></span></h4>
                    <h4><small>Global Coordinates: </small><span id="system-global-position"></span></h4>
                    <h4><small>Local Coordinates: </small><span id="system-local-position"></span></h4>
                    <h4><small>Star Type: </small><span id="system-star-type"></span></h4>
                    <h4><small>Warp Chance: </small><span id="system-warp-chance"></span></h4>

                    <hr class="margin-right-15">

                    <h2>Celestial Bodies</h2>
                    <h3>Planets:</h3>

                    <button id='btn-destination' class="btn btn-default btn-block">Set Destination</button>

                </div>
            </div>
        </div>

    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="/static/js/jquery-2.2.1.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="/static/js/bootstrap.min.js"></script>
    <!-- Jquery Validate Library -->
    <script src="/static/js/jquery_validate/jquery.validate.js"></script>
    <!-- Drag Scroll Library -->
    <script src="/static/js/dragscroll/dragscroll.js"></script>

    <!-- Main JavaScript file -->
    <script src="/static/js/bsg_main.js"></script>

    <script>
        /** @namespace player_galaxy.system_list */
        /** @namespace player_galaxy.current_position */
        /** @namespace player_galaxy.system_list[sys].global_position */

        $(document).ready(function(){
            var player_galaxy = {{ player_galaxy|tojson|safe }};
            var system;

            var c = document.getElementById("star-canvas");
            var ctx = c.getContext("2d");
            var img = document.getElementById("star_tile");
            var pat = ctx.createPattern(img, "repeat");
            var remainder = Math.max(document.documentElement.clientHeight, window.innerHeight || 0) - $("#navbar").height() - $("#map-header").height() - 30;
            var starmap = $("#star-map");

            {# fill and make canvas. #}
            if (remainder > 2016) {
                starmap.height(2016)
            } else {
                starmap.height(remainder)
            }

            ctx.rect(0, 0, c.width, c.height);
            ctx.fillStyle = pat;
            ctx.fill();

            var current_position = player_galaxy.current_position;
            var selected_position = current_position;

            for (var sys in player_galaxy.system_list) {
                var global_position = player_galaxy.system_list[sys].global_position;
                var local_position = [global_position[0] - current_position[0], global_position[1] - current_position[1]];

                player_galaxy.system_list[sys].local_position = local_position;

                var src = player_galaxy.system_list[sys].star_file;
                src.split(' ').join('_');

                if ( local_position[0] >= -30 && local_position[0] <= 30 && local_position[1] >= -30 && local_position[1] <= 30) {
                    var el = $("<img>").attr({
                        src: src,
                        alt: "star",
                        class: "solar-system",
                        "data-toggle": "tooltip",
                        "data-container": "body",
                        title: "(" + local_position[0] + ", " + local_position[1] + ")",
                        id: "(" + global_position[0] + ", " + global_position[1] + ")"
                    }).css({
                        position: 'absolute',
                        left: (local_position[0] + 30) * 32 + 32,
                        top: (-local_position[1] + 30) * 32 + 32
                    });
                    starmap.append(el);
                }
            }

            $('[data-toggle="tooltip"]').tooltip();

            $('.nav-div-links').on('click', function(e) {
                setTimeout(function(){
                    starmap.scrollLeft((starmap[0].scrollWidth - starmap[0].clientWidth) / 2);
                    starmap.scrollTop((starmap[0].scrollHeight - starmap[0].clientHeight)/ 2);
                }, 1);
            });

            $('.solar-system').on("click", function(e) {
                system = player_galaxy.system_list[$(this).attr('id')];
                $('#system-name').text(system.name);
                $('#system-global-position').text("(" + system.global_position[0] + ", " + system.global_position[1] + ")");
                $('#system-local-position').text("(" + system.local_position[0] + ", " + system.local_position[1] + ")");
                $('#system-star-type').text(system.star_type);
                $('#system-warp-chance').text(Math.sqrt(Math.pow(system.local_position[0], 2) + Math.pow(system.local_position[1], 2)));
            });

            $('#btn-destination').on('click', function(e) {
                selected_position = system.global_position;
                $('#warp').attr({'disabled': false});
                $('#warp-coords').attr({'hidden': false}).text('Warp Coords: ' + selected_position);
            });

            $('.next-turn').on("click", function(e) {
                $.ajax({
                    type: 'POST',
                    url: '/next_turn',
                    data: JSON.stringify({
                        'next_turn_type': $(this).attr('id'),
                        'selected_position': selected_position
                    }),
                    dataType: 'json',
                    contentType: 'application/json',
                    success: function(server_data){
                        if (server_data['refresh'] === true) {
                            location.reload();
                        }
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        alert('Error: Unable to load page: ' + thrownError);
                    }
                })
            });
        });
    </script>
</body>
</html>